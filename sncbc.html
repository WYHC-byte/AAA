<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é’å†¥ä¿®ä»™å½•</title>
    <style>
        :root {
            --primary: #2c5f2d;
            --secondary: #97c1a9;
            --gold: #ffd700;
        }

        body {
            font-family: 'Microsoft Yahei', sans-serif;
            margin: 0;
            min-height: 100vh;
            display: grid;
            grid-template-columns: 200px 1fr;
            background: #e9f5e9;
        }

        /* å»ºç­‘é¢æ¿ */
        .building-panel {
            background: rgba(255,255,255,0.9);
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .building {
            padding: 15px;
            margin: 10px 0;
            background: var(--secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .building:hover {
            transform: translateX(5px);
        }

        /* ä¸»æ¸¸æˆåŒº */
        .main-content {
            padding: 20px;
            position: relative;
        }

        /* çŠ¶æ€æ  */
        .status-bar {
            display: flex;
            gap: 20px;
            padding: 10px;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        /* çµç”° */
        .field {
            display: grid;
            grid-template-columns: repeat(3, 100px);
            gap: 10px;
            margin: 20px 0;
        }

        .plot {
            width: 100px;
            height: 100px;
            border: 2px solid var(--primary);
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            background: #fff;
        }

        .herb-icon {
            width: 50px;
            height: 50px;
            background: var(--primary);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: grow 0.5s ease-out;
        }

        @keyframes grow {
            0% { transform: translate(-50%, -50%) scale(0); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .timer {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
        }

        /* NPCå¯¹è¯æ¡† */
        .npc-dialog {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            padding: 20px;
            display: none;
        }

        /* ç‚¼ä¸¹ç•Œé¢ */
        .alchemy-panel {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 20px;
        }

        .ingredient {
            border: 2px solid var(--primary);
            padding: 10px;
            text-align: center;
            cursor: pointer;
        }

        .selected {
            background: var(--secondary);
        }
    </style>
</head>
<body>
    <!-- å»ºç­‘é¢æ¿ -->
    <div class="building-panel">
        <div class="building" onclick="showAlchemyPanel()">ç‚¼ä¸¹æˆ¿</div>
        <div class="building" onclick="showLibrary()">è—ç»é˜</div>
        <div class="building" onclick="showTaskNPC()">ä»»åŠ¡å ‚</div>
    </div>

    <!-- ä¸»æ¸¸æˆåŒº -->
    <div class="main-content">
        <div class="status-bar">
            <span>ğŸ’°åŠŸå¾·: <span id="gold">0</span></span>
            <span>ğŸŒ¿çµè‰: <span id="herbs">0</span></span>
            <span>âš¡å¢ƒç•Œ: <span id="realm">å‡¡äºº</span></span>
        </div>

        <div class="field" id="field"></div>

        <!-- ç‚¼ä¸¹é¢æ¿ -->
        <div class="npc-dialog" id="alchemyPanel">
            <h3>ä¹è½¬ç‚¼ä¸¹ç‚‰</h3>
            <div class="alchemy-panel" id="ingredients"></div>
            <button onclick="startAlchemy()">å¼€ç‚‰ç‚¼ä¸¹</button>
            <button onclick="closeDialog('alchemyPanel')">å…³é—­</button>
        </div>

        <!-- ä»»åŠ¡å¯¹è¯æ¡† -->
        <div class="npc-dialog" id="taskDialog">
            <h3 id="npcName">è¯è€</h3>
            <p id="questDesc"></p>
            <p>å¥–åŠ±ï¼š<span id="questReward"></span></p>
            <button onclick="acceptQuest()">æ¥å—ä»»åŠ¡</button>
            <button onclick="closeDialog('taskDialog')">å…³é—­</button>
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        const state = {
            gold: 0,
            herbs: 0,
            realm: 'å‡¡äºº',
            exp: 0,
            plantingTime: 10,
            plots: Array(6).fill({ planted: false }),
            inventory: {
                herbs: { 'ä¸ƒæ˜Ÿè‰': 0, 'é¾™æ¶é¦™': 0 },
                pills: {}
            },
            currentQuest: null
        };

        // åˆå§‹åŒ–çµç”°
        function initField() {
            const field = document.getElementById('field');
            field.innerHTML = state.plots.map((plot, index) => `
                <div class="plot" data-index="${index}" onclick="handlePlot(${index})">
                    ${plot.planted ? `
                        <div class="herb-icon"></div>
                        <div class="timer">${getTimerText(index)}</div>
                    ` : ''}
                </div>
            `).join('');
        }

        // å¤„ç†åœ°å—ç‚¹å‡»
        function handlePlot(index) {
            state.plots[index].planted ? harvest(index) : plant(index);
        }

        // ç§æ¤é€»è¾‘
        function plant(index) {
            state.plots[index] = {
                planted: true,
                startTime: Date.now(),
                duration: state.plantingTime * 1000
            };
            updatePlot(index);
            startGrowthTimer(index);
        }

        // æ”¶è·é€»è¾‘
        function harvest(index) {
            const plot = state.plots[index];
            if (Date.now() - plot.startTime < plot.duration) return;

            state.herbs++;
            state.exp += 10;
            checkRealm();
            state.plots[index].planted = false;
            updateDisplay();
        }

        // å¢ƒç•Œçªç ´
        function checkRealm() {
            const realms = [
                { exp: 100, name: 'ç‚¼æ°”æœŸ' },
                { exp: 500, name: 'ç­‘åŸºæœŸ' },
                { exp: 2000, name: 'é‡‘ä¸¹æœŸ' }
            ];

            const newRealm = realms.reduce((acc, r) => 
                state.exp >= r.exp ? r.name : acc, 'å‡¡äºº'
            );

            if (newRealm !== state.realm) {
                state.realm = newRealm;
                alert(`âœ¨çªç ´è‡³${newRealm}ï¼âœ¨`);
                updateDisplay();
            }
        }

        // æ˜¾ç¤ºç‚¼ä¸¹é¢æ¿
        function showAlchemyPanel() {
            document.getElementById('ingredients').innerHTML = 
                Object.entries(state.inventory.herbs).map(([name, count]) => `
                    <div class="ingredient" onclick="selectIngredient('${name}')">
                        <h4>${name}</h4>
                        <span>åº“å­˜: ${count}</span>
                    </div>
                `).join('');
            showDialog('alchemyPanel');
        }

        // ææ–™é€‰æ‹©
        let selectedIngredients = [];
        function selectIngredient(name) {
            const index = selectedIngredients.indexOf(name);
            if (index > -1) {
                selectedIngredients.splice(index, 1);
            } else if (selectedIngredients.length < 3) {
                selectedIngredients.push(name);
            }
            updateSelection();
        }

        function updateSelection() {
            document.querySelectorAll('.ingredient').forEach(el => {
                el.classList.toggle('selected', 
                    selectedIngredients.includes(el.querySelector('h4').textContent)
                );
            });
        }

        // ç‚¼ä¸¹é€»è¾‘
        function startAlchemy() {
            if (selectedIngredients.length !== 3) {
                alert('éœ€è¦é€‰æ‹©ä¸‰ç§ææ–™ï¼');
                return;
            }

            // æ£€æŸ¥é…æ–¹
            const recipe = Object.entries({
                'ç­‘åŸºä¸¹': ['ä¸ƒæ˜Ÿè‰', 'é¾™æ¶é¦™', 'ä¸ƒæ˜Ÿè‰'],
                'å›æ˜¥æ•£': ['ä¸ƒæ˜Ÿè‰', 'ä¸ƒæ˜Ÿè‰', 'ä¸ƒæ˜Ÿè‰']
            }).find(([name, recipe]) => 
                JSON.stringify([...selectedIngredients].sort()) === 
                JSON.stringify([...recipe].sort())
            );

            if (recipe) {
                state.inventory.pills[recipe[0]] = (state.inventory.pills[recipe[0]] || 0) + 1;
                alert(`æˆåŠŸç‚¼åˆ¶${recipe[0]}ï¼`);
            } else {
                alert('ç‚¼ä¸¹å¤±è´¥...');
            }
            closeDialog('alchemyPanel');
        }

        // ä»»åŠ¡ç³»ç»Ÿ
        function showTaskNPC() {
            const quest = {
                desc: 'æ”¶é›†5æ ªä¸ƒæ˜Ÿè‰',
                requirement: { herb: 'ä¸ƒæ˜Ÿè‰', count: 5 },
                reward: { gold: 100, item: 'ç­‘åŸºä¸¹' }
            };

            document.getElementById('questDesc').textContent = quest.desc;
            document.getElementById('questReward').textContent = 
                `${quest.reward.gold}é‡‘å¸ + ${quest.reward.item}`;
            state.currentQuest = quest;
            showDialog('taskDialog');
        }

        function acceptQuest() {
            if (state.inventory.herbs['ä¸ƒæ˜Ÿè‰'] >= 5) {
                state.gold += 100;
                state.inventory.pills['ç­‘åŸºä¸¹'] = 1;
                alert('ä»»åŠ¡å®Œæˆï¼è·å¾—ç­‘åŸºä¸¹');
            } else {
                alert('çµè‰ä¸è¶³ï¼Œç»§ç»­åŠªåŠ›å§ï¼');
            }
            closeDialog('taskDialog');
        }

        // é€šç”¨å¯¹è¯æ¡†æ§åˆ¶
        function showDialog(id) {
            document.getElementById(id).style.display = 'block';
        }

        function closeDialog(id) {
            document.getElementById(id).style.display = 'none';
            selectedIngredients = [];
        }

        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay() {
            document.getElementById('gold').textContent = state.gold;
            document.getElementById('herbs').textContent = state.herbs;
            document.getElementById('realm').textContent = state.realm;
            initField();
        }

        // å®šæ—¶å™¨
        function startGrowthTimer(index) {
            const interval = setInterval(() => {
                if (!state.plots[index].planted) {
                    clearInterval(interval);
                    return;
                }
                updatePlot(index);
            }, 1000);
        }

        function updatePlot(index) {
            const plot = document.querySelector(`[data-index="${index}"]`);
            if (!state.plots[index].planted) {
                plot.innerHTML = '';
                return;
            }
            
            const remaining = Math.ceil(
                (state.plots[index].duration - (Date.now() - state.plots[index].startTime)) / 1000
            );
            
            plot.innerHTML = `
                <div class="herb-icon"></div>
                <div class="timer">${remaining > 0 ? `${remaining}s` : 'å¯æ”¶è·'}
            `;
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        initField();
        setInterval(() => {
            state.gold++;
            updateDisplay();
        }, 1000);
    </script>
</body>
</html>