<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é’å†¥ä¿®ä»™å½•</title>
    <style>
        :root {
            --primary: #2c5f2d;
            --secondary: #97c1a9;
            --gold: #ffd700;
        }

        body {
            font-family: 'Microsoft Yahei', sans-serif;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: #e9f5e9;
        }

        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .game-container {
                flex-direction: column;
            }

            .building-panel {
                width: 100%;
                height: auto;
                display: flex;
                overflow-x: auto;
                padding: 10px;
            }

            .building {
                min-width: 120px;
                margin: 0 5px;
            }

            .field {
                grid-template-columns: repeat(2, 1fr) !important;
            }

            .plot {
                width: auto !important;
                height: 120px !important;
            }
        }

        .game-container {
            display: flex;
            flex: 1;
        }

        /* å»ºç­‘é¢æ¿ */
        .building-panel {
            background: rgba(255,255,255,0.9);
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .building {
            padding: 15px;
            margin: 10px 0;
            background: var(--secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .building:hover {
            transform: translateX(5px);
        }

        /* ä¸»æ¸¸æˆåŒº */
        .main-content {
            padding: 20px;
            position: relative;
            flex: 1;
        }

        /* çŠ¶æ€æ  */
        .status-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .status-item {
            padding: 5px 10px;
            background: var(--secondary);
            border-radius: 5px;
        }

        /* çµç”° */
        .field {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }

        .plot {
            aspect-ratio: 1;
            border: 2px solid var(--primary);
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            background: #fff;
        }

        .herb-icon {
            width: 50%;
            height: 50%;
            background: var(--primary);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation: grow 0.5s ease-out;
        }

        /* å¯¼èˆªæ  */
        .nav-bar {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background: white;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--primary);
        }

        .nav-item.active {
            color: var(--gold);
        }

        /* ç‰©å“æ  */
        .inventory {
            background: white;
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }

        .inventory-item {
            background: var(--secondary);
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }

        @keyframes grow {
            0% { transform: translate(-50%, -50%) scale(0); }
            100% { transform: translate(-50%, -50%) scale(1); }
        }

        .timer {
            position: absolute;
            bottom: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 12px;
        }

        .npc-dialog {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 90%;
            max-width: 300px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
            padding: 20px;
            display: none;
            z-index: 1000;
        }

        .alchemy-panel {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            padding: 20px;
        }

        .ingredient {
            border: 2px solid var(--primary);
            padding: 10px;
            text-align: center;
            cursor: pointer;
        }

        .selected {
            background: var(--secondary);
        }

        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }

        button:hover {
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- å»ºç­‘é¢æ¿ -->
        <div class="building-panel">
            <div class="building" onclick="showAlchemyPanel()">ç‚¼ä¸¹æˆ¿</div>
            <div class="building" onclick="showLibrary()">è—ç»é˜</div>
            <div class="building" onclick="showTaskNPC()">ä»»åŠ¡å ‚</div>
        </div>

        <!-- ä¸»æ¸¸æˆåŒº -->
        <div class="main-content">
            <div class="status-bar">
                <div class="status-item">ğŸ’°åŠŸå¾·: <span id="gold">0</span></div>
                <div class="status-item">ğŸŒ¿çµè‰: <span id="herbs">0</span></div>
                <div class="status-item">âš¡å¢ƒç•Œ: <span id="realm">å‡¡äºº</span></div>
                <div class="status-item">âœ¨ç»éªŒ: <span id="exp">0</span>/100</div>
            </div>

            <!-- ç‰©å“æ  -->
            <div class="inventory">
                <h3>ç‰©å“æ </h3>
                <div class="inventory-grid" id="inventory"></div>
            </div>

            <div class="field" id="field"></div>

            <!-- ç‚¼ä¸¹é¢æ¿ -->
            <div class="npc-dialog" id="alchemyPanel">
                <h3>ä¹è½¬ç‚¼ä¸¹ç‚‰</h3>
                <div class="alchemy-panel" id="ingredients"></div>
                <button onclick="startAlchemy()">å¼€ç‚‰ç‚¼ä¸¹</button>
                <button onclick="closeDialog('alchemyPanel')">å…³é—­</button>
            </div>

            <!-- ä»»åŠ¡å¯¹è¯æ¡† -->
            <div class="npc-dialog" id="taskDialog">
                <h3 id="npcName">è¯è€</h3>
                <p id="questDesc"></p>
                <p>å¥–åŠ±ï¼š<span id="questReward"></span></p>
                <button onclick="acceptQuest()">æ¥å—ä»»åŠ¡</button>
                <button onclick="closeDialog('taskDialog')">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨å¯¼èˆªæ  -->
    <div class="nav-bar">
        <a href="sncbc.html" class="nav-item active">
            <span>ğŸ </span>
            <span>ä¸»é¡µ</span>
        </a>
        <a href="my.html" class="nav-item">
            <span>ğŸ‘¤</span>
            <span>æˆ‘çš„</span>
        </a>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€
        let state = {
            gold: 0,
            herbs: 0,
            realm: 'å‡¡äºº',
            exp: 0,
            plantingTime: 10,
            plots: Array(6).fill({ planted: false }),
            inventory: {
                herbs: { 'ä¸ƒæ˜Ÿè‰': 0, 'é¾™æ¶é¦™': 0, 'åœ°çµè‰': 0 },
                pills: { 'ç­‘åŸºä¸¹': 0, 'å›æ˜¥æ•£': 0 }
            },
            currentQuest: null,
            lastSaveTime: Date.now()
        };

        // åŠ è½½å­˜æ¡£
        function loadGame() {
            const savedState = localStorage.getItem('gameState');
            if (savedState) {
                state = JSON.parse(savedState);
                updateDisplay();
            }
        }

        // ä¿å­˜æ¸¸æˆ
        function saveGame() {
            localStorage.setItem('gameState', JSON.stringify(state));
            state.lastSaveTime = Date.now();
        }

        // è‡ªåŠ¨ä¿å­˜
        setInterval(saveGame, 30000);

        // åˆå§‹åŒ–çµç”°
        function initField() {
            const field = document.getElementById('field');
            field.innerHTML = state.plots.map((plot, index) => `
                <div class="plot" data-index="${index}" onclick="handlePlot(${index})">
                    ${plot.planted ? `
                        <div class="herb-icon"></div>
                        <div class="timer">${getTimerText(index)}</div>
                    ` : ''}
                </div>
            `).join('');
        }

        // æ›´æ–°ç‰©å“æ æ˜¾ç¤º
        function updateInventory() {
            const inventoryEl = document.getElementById('inventory');
            let html = '';
            
            // æ˜¾ç¤ºçµè‰
            for (const [name, count] of Object.entries(state.inventory.herbs)) {
                if (count > 0) {
                    html += `
                        <div class="inventory-item">
                            <div>ğŸŒ¿ ${name}</div>
                            <div>æ•°é‡: ${count}</div>
                        </div>
                    `;
                }
            }
            
            // æ˜¾ç¤ºä¸¹è¯
            for (const [name, count] of Object.entries(state.inventory.pills)) {
                if (count > 0) {
                    html += `
                        <div class="inventory-item">
                            <div>ğŸ’Š ${name}</div>
                            <div>æ•°é‡: ${count}</div>
                        </div>
                    `;
                }
            }
            
            inventoryEl.innerHTML = html;
        }

        // å¤„ç†åœ°å—ç‚¹å‡»
        function handlePlot(index) {
            if (!state.plots[index].planted) {
                plant(index);
            } else if (isReadyToHarvest(index)) {
                harvest(index);
            }
        }

        function isReadyToHarvest(index) {
            const plot = state.plots[index];
            return plot.planted && Date.now() - plot.startTime >= plot.duration;
        }

        // ç§æ¤é€»è¾‘
        function plant(index) {
            state.plots[index] = {
                planted: true,
                startTime: Date.now(),
                duration: state.plantingTime * 1000
            };
            updatePlot(index);
            startGrowthTimer(index);
            saveGame();
        }

        // æ”¶è·é€»è¾‘
        function harvest(index) {
            const herbTypes = ['ä¸ƒæ˜Ÿè‰', 'é¾™æ¶é¦™', 'åœ°çµè‰'];
            const randomHerb = herbTypes[Math.floor(Math.random() * herbTypes.length)];
            
            state.inventory.herbs[randomHerb]++;
            state.herbs++;
            state.exp += 10;
            state.plots[index] = { planted: false };
            
            checkRealm();
            updateDisplay();
            saveGame();
        }

        // å¢ƒç•Œçªç ´
        function checkRealm() {
            const realms = [
                { exp: 100, name: 'ç‚¼æ°”æœŸ' },
                { exp: 500, name: 'ç­‘åŸºæœŸ' },
                { exp: 2000, name: 'é‡‘ä¸¹æœŸ' },
                { exp: 5000, name: 'å…ƒå©´æœŸ' }
            ];

            const newRealm = realms.reduce((acc, r) => 
                state.exp >= r.exp ? r.name : acc, 'å‡¡äºº'
            );

            if (newRealm !== state.realm) {
                state.realm = newRealm;
                alert(`âœ¨æ­å–œçªç ´è‡³${newRealm}ï¼âœ¨`);
                updateDisplay();
                saveGame();
            }
        }

        // ç‚¼ä¸¹ç³»ç»Ÿ
        function showAlchemyPanel() {
            document.getElementById('ingredients').innerHTML = 
                Object.entries(state.inventory.herbs).map(([name, count]) => `
                    <div class="ingredient" onclick="selectIngredient('${name}')">
                        <h4>${name}</h4>
                        <span>åº“å­˜: ${count}</span>
                    </div>
                `).join('');
            showDialog('alchemyPanel');
        }

        let selectedIngredients = [];
        function selectIngredient(name) {
            if (state.inventory.herbs[name] <= 0) {
                alert('ææ–™ä¸è¶³ï¼');
                return;
            }
            
            const index = selectedIngredients.indexOf(name);
            if (index > -1) {
                selectedIngredients.splice(index, 1);
            } else if (selectedIngredients.length < 3) {
                selectedIngredients.push(name);
            }
            updateSelection();
        }

        function startAlchemy() {
            if (selectedIngredients.length !== 3) {
                alert('éœ€è¦é€‰æ‹©ä¸‰ç§ææ–™ï¼');
                return;
            }

            // æ¶ˆè€—ææ–™
            selectedIngredients.forEach(herb => {
                state.inventory.herbs[herb]--;
            });

            const recipes = {
                'ç­‘åŸºä¸¹': ['ä¸ƒæ˜Ÿè‰', 'é¾™æ¶é¦™', 'åœ°çµè‰'],
                'å›æ˜¥æ•£': ['ä¸ƒæ˜Ÿè‰', 'ä¸ƒæ˜Ÿè‰', 'ä¸ƒæ˜Ÿè‰']
            };

            // æ£€æŸ¥é…æ–¹
            const recipe = Object.entries(recipes).find(([name, recipe]) => 
                JSON.stringify([...selectedIngredients].sort()) === 
                JSON.stringify([...recipe].sort())
            );

            if (recipe) {
                state.inventory.pills[recipe[0]] = (state.inventory.pills[recipe[0]] || 0) + 1;
                alert(`æˆåŠŸç‚¼åˆ¶${recipe[0]}ï¼`);
                state.exp += 50;
                checkRealm();
            } else {
                alert('ç‚¼ä¸¹å¤±è´¥...');
            }

            selectedIngredients = [];
            updateDisplay();
            saveGame();
            closeDialog('alchemyPanel');
        }

        // æ›´æ–°æ˜¾ç¤º
        function updateDisplay() {
            document.getElementById('gold').textContent = state.gold;
            document.getElementById('herbs').textContent = state.herbs;
            document.getElementById('realm').textContent = state.realm;
            document.getElementById('exp').textContent = `${state.exp}`;
            updateInventory();
            initField();
        }

        // å®šæ—¶å™¨ç›¸å…³å‡½æ•°
        function getTimerText(index) {
            const plot = state.plots[index];
            if (!plot.planted) return '';
            
            const remaining = Math.ceil(
                (plot.duration - (Date.now() - plot.startTime)) / 1000
            );
            return remaining > 0 ? `${remaining}s` : 'å¯æ”¶è·';
        }

        function startGrowthTimer(index) {
            const interval = setInterval(() => {
                if (!state.plots[index].planted) {
                    clearInterval(interval);
                    return;
                }
                updatePlot(index);
            }, 1000);
        }

        function updatePlot(index) {
            const plot = document.querySelector(`[data-index="${index}"]`);
            if (!state.plots[index].planted) {
                plot.innerHTML = '';
                return;
            }
            
            plot.innerHTML = `
                <div class="herb-icon"></div>
                <div class="timer">${getTimerText(index)}</div>
            `;
        }

        // å¯¹è¯æ¡†æ§åˆ¶
        function showDialog(id) {
            document.getElementById(id).style.display = 'block';
        }

        function closeDialog(id) {
            document.getElementById(id).style.display = 'none';
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        loadGame();
        initField();
        setInterval(() => {
            state.gold++;
            updateDisplay();
        }, 1000);

        // é¡µé¢å…³é—­å‰ä¿å­˜
        window.addEventListener('beforeunload', saveGame);
    </script>
</body>
</html>